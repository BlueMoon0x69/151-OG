<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¥ Collection Pok√©mon 151 - Gestion Google Sheets</title>
    
    <!-- Styles existants -->
    <link rel="stylesheet" href="css/styles.css">
    
    <style>
        /* Styles suppl√©mentaires pour le mode Google Sheets */
        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }
        
        .sync-status.syncing { background: #fef3c7; }
        .sync-status.synced { background: #d1fae5; }
        .sync-status.error { background: #fee2e2; }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading-overlay" id="loading">
        <div class="loading-content">
            <div class="spinner"></div>
            <h2>Chargement de votre collection...</h2>
            <p style="color: #95a5a6;">R√©cup√©ration des donn√©es depuis Google Sheets</p>
        </div>
    </div>

    <!-- Status de synchronisation -->
    <div class="sync-status synced" id="syncStatus">
        <span id="syncIcon">‚úÖ</span>
        <span id="syncText">Synchronis√©</span>
    </div>

    <!-- Container principal -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="title">üé¥ Ma Collection Pok√©mon 151</h1>
            <p class="subtitle">G√©r√©e via Google Sheets</p>
        </div>

        <!-- Compteur -->
        <div class="counter" id="counter">
            <span class="owned">0</span> / <span id="totalCards">0</span> cartes poss√©d√©es
            (<span class="missing" id="missingCards">0</span> manquantes)
        </div>

        <!-- Boutons -->
        <div class="buttons-container">
            <input type="text" id="searchBox" class="search-box" placeholder="Rechercher..." oninput="filterCards()">
            <button id="filterBtn" class="filter-toggle-btn" onclick="toggleFilter()">
                üîç Afficher uniquement les cartes manquantes
            </button>
            <button id="sortBtn" class="sort-toggle-btn" onclick="toggleSort()">
                üî¢ Ordre Pok√©dex
            </button>
            <button class="sort-toggle-btn" onclick="refreshData()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                üîÑ Actualiser
            </button>
        </div>

        <!-- Grille de cartes -->
        <div class="cards-grid" id="cardsGrid">
            <!-- Les cartes seront ins√©r√©es ici par JavaScript -->
        </div>

        <!-- Modal Lightbox -->
        <div class="modal" id="modal" onclick="closeModal()">
            <span class="close">&times;</span>
            <img class="modal-content" id="modal-img">
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>R√©alis√© avec <span class="heart">‚ù§Ô∏è</span> pour mon <span class="poussinou">Poussinou</span> üê£</p>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION GOOGLE SHEETS
        // ========================================
        
        // ‚ö†Ô∏è IMPORTANT : Remplacez cette URL par celle de votre Google Sheet
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1NYdX5dbtBqYI0Jw9AAuXibAUw95lraH_78wxirBfPrM/edit?gid=339112060#gid=339112060';
        
        // ID du Google Sheet (√† extraire de l'URL)
        const SHEET_ID = '1NYdX5dbtBqYI0Jw9AAuXibAUw95lraH_78wxirBfPrM';
        
        // Cl√© API Google (√† cr√©er dans Google Cloud Console)
        const API_KEY = 'AIzaSyCprd-1_qAoGBWqGMYd0dpB5KDvpdWgv3I';
        
        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        let allCards = [];
        let currentSortMode = 'alphabet';
        let filterActive = false;
        
        // ========================================
        // CHARGEMENT DES DONN√âES
        // ========================================
        
        async function loadFromGoogleSheets() {
            try {
                showLoading(true);
                updateSyncStatus('syncing', 'Synchronisation...');
                
                // URL de l'API Google Sheets
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/collection_pokemon?key=${API_KEY}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Erreur de chargement');
                }
                
                const data = await response.json();
                const rows = data.values;
                
                // Transformer les donn√©es en objets
                allCards = rows.slice(1).map(row => ({
                    name: row[0] || '',
                    number: row[1] || '',
                    series: row[2] || '',
                    price: row[3] || '0',
                    rarity: row[4] || 'Illustration Rare',
                    cardmarketUrl: row[5] || '',
                    imageUrl: row[6] || ''
                }));
                
                // Afficher les cartes
                displayCards();
                updateCounter();
                loadOwnedState();
                
                updateSyncStatus('synced', `‚úÖ ${allCards.length} cartes charg√©es`);
                showLoading(false);
                
            } catch (error) {
                console.error('Erreur:', error);
                updateSyncStatus('error', '‚ùå Erreur de chargement');
                showLoading(false);
                
                // Message d'erreur
                document.getElementById('cardsGrid').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px; background: white; border-radius: 15px;">
                        <h2 style="color: #e74c3c; margin-bottom: 20px;">‚ùå Impossible de charger les donn√©es</h2>
                        <p style="color: #95a5a6; margin-bottom: 30px;">V√©rifiez la configuration de votre Google Sheet</p>
                        <button onclick="refreshData()" style="padding: 15px 30px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em;">
                            üîÑ R√©essayer
                        </button>
                    </div>
                `;
            }
        }
        
        // ========================================
        // AFFICHAGE DES CARTES
        // ========================================
        
        function displayCards() {
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = '';
            
            allCards.forEach((card, index) => {
                const cardElement = createCardElement(card, index);
                grid.appendChild(cardElement);
            });
            
            document.getElementById('totalCards').textContent = allCards.length;
        }
        
        function createCardElement(card, index) {
            const div = document.createElement('div');
            div.className = 'card-item';
            div.dataset.index = index;
            
            // Obtenir les √©toiles selon la raret√©
            const stars = {
                'Commune': '‚≠ê',
                'Peu commune': '‚≠ê‚≠ê',
                'Rare': '‚≠ê‚≠ê‚≠ê',
                'Illustration Rare': '‚≠ê‚≠ê‚≠ê',
                'Ultra Rare': '‚≠ê‚≠ê‚≠ê‚≠ê',
                'SIR': '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê',
                'Hyper Rare': '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê'
            };
            
            const rarityStars = stars[card.rarity] || '‚≠ê‚≠ê‚≠ê';
            
            // Prix format√©
            const formattedPrice = parseFloat(card.price).toFixed(2).replace('.', ',');
            
            // G√©n√©rer l'ID de la carte
            const cardId = 'card-' + card.name.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]+/g, '-');
            
            div.innerHTML = `
                <div class="card-visual">
                    <div class="owned-checkbox-top" onclick="toggleOwned(event, ${index})"></div>
                    <img src="${card.imageUrl}" alt="${card.name}" class="card-image" onclick="openModal('${card.imageUrl}')">
                </div>
                <div class="card-info">
                    <div class="card-name" id="${cardId}">${card.name}</div>
                    <div class="card-number">${card.number}</div>
                    <div style="font-size: 0.85em; color: #95a5a6; margin-top: 3px;">üì¶ ${card.series}</div>
                    <div style="margin-top: 8px;">
                        <span class="rarity-badge ir">${card.rarity}</span>
                        <span style="margin-left: 5px;">${rarityStars}</span>
                    </div>
                    <div style="margin-top: 8px;">
                        <span class="price" style="color: #ff6a00; font-weight: bold;">
                            ${formattedPrice} ‚Ç¨ 
                            <span style="display: inline-flex; align-items: center; justify-content: center; background: #10b981; color: white; padding: 2px 5px; border-radius: 2px; font-size: 0.6em; margin-left: 4px; font-weight: 600; height: 13px;">NM</span>
                            <span style="display: inline-flex; width: 14px; height: 10px; margin-left: 3px; border-radius: 2px; overflow: hidden;">
                                <span style="flex: 1; background: #0055A4;"></span>
                                <span style="flex: 1; background: white;"></span>
                                <span style="flex: 1; background: #EF4135;"></span>
                            </span>
                        </span>
                    </div>
                    <div class="zoom-icon" onclick="openModal('${card.imageUrl}')">üîé</div>
                    ${card.cardmarketUrl ? `<a href="${card.cardmarketUrl}" target="_blank" class="cardmarket-btn" style="text-decoration: none; color: #0066cc;">üõí Cardmarket</a>` : ''}
                </div>
            `;
            
            return div;
        }
        
        // ========================================
        // GESTION DES CARTES POSS√âD√âES
        // ========================================
        
        function toggleOwned(event, index) {
            event.stopPropagation();
            const checkbox = event.target;
            
            checkbox.classList.toggle('checked');
            if (checkbox.classList.contains('checked')) {
                checkbox.textContent = '‚úì';
            } else {
                checkbox.textContent = '';
            }
            
            saveOwnedState();
            updateCounter();
            
            if (filterActive) {
                applyFilter();
            }
        }
        
        function saveOwnedState() {
            const owned = {};
            document.querySelectorAll('.card-item').forEach((card, index) => {
                const checkbox = card.querySelector('.owned-checkbox-top');
                if (checkbox && checkbox.classList.contains('checked')) {
                    owned[index] = true;
                }
            });
            localStorage.setItem('pokemon_owned_cards_gs', JSON.stringify(owned));
        }
        
        function loadOwnedState() {
            try {
                const owned = JSON.parse(localStorage.getItem('pokemon_owned_cards_gs') || '{}');
                document.querySelectorAll('.card-item').forEach((card, index) => {
                    const checkbox = card.querySelector('.owned-checkbox-top');
                    if (checkbox && owned[index]) {
                        checkbox.classList.add('checked');
                        checkbox.textContent = '‚úì';
                    }
                });
            } catch (e) {
                console.error('Erreur chargement √©tat:', e);
            }
        }
        
        function updateCounter() {
            const owned = document.querySelectorAll('.owned-checkbox-top.checked').length;
            const total = allCards.length;
            const missing = total - owned;
            
            document.querySelector('.counter .owned').textContent = owned;
            document.querySelector('.counter #totalCards').textContent = total;
            document.querySelector('.counter #missingCards').textContent = missing;
        }
        
        // ========================================
        // FONCTIONS UTILITAIRES
        // ========================================
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
        
        function updateSyncStatus(status, text) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.className = `sync-status ${status}`;
            document.getElementById('syncText').textContent = text;
            
            const icons = {
                syncing: 'üîÑ',
                synced: '‚úÖ',
                error: '‚ùå'
            };
            document.getElementById('syncIcon').textContent = icons[status];
        }
        
        function refreshData() {
            loadFromGoogleSheets();
        }
        
        function openModal(imageUrl) {
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('modal-img').src = imageUrl;
        }
        
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }
        
        function filterCards() {
            const searchValue = document.getElementById('searchBox').value.toLowerCase();
            document.querySelectorAll('.card-item').forEach(card => {
                const name = card.querySelector('.card-name').textContent.toLowerCase();
                card.style.display = (searchValue === '' || name.startsWith(searchValue)) ? 'block' : 'none';
            });
        }
        
        function toggleFilter() {
            filterActive = !filterActive;
            const btn = document.getElementById('filterBtn');
            
            if (filterActive) {
                btn.classList.add('active');
                btn.innerHTML = 'üîÑ Afficher toutes les cartes';
                applyFilter();
            } else {
                btn.classList.remove('active');
                btn.innerHTML = 'üîç Afficher uniquement les cartes manquantes';
                showAllCards();
            }
        }
        
        function applyFilter() {
            document.querySelectorAll('.card-item').forEach(card => {
                const checkbox = card.querySelector('.owned-checkbox-top');
                card.style.display = (checkbox && checkbox.classList.contains('checked')) ? 'none' : 'block';
            });
        }
        
        function showAllCards() {
            document.querySelectorAll('.card-item').forEach(card => {
                card.style.display = 'block';
            });
        }
        
        function toggleSort() {
            const btn = document.getElementById('sortBtn');
            if (currentSortMode === 'alphabet') {
                currentSortMode = 'pokedex';
                btn.innerHTML = 'üî§ Ordre alphab√©tique';
                // Impl√©menter le tri Pok√©dex si n√©cessaire
            } else {
                currentSortMode = 'alphabet';
                btn.innerHTML = 'üî¢ Ordre Pok√©dex';
            }
            displayCards();
            loadOwnedState();
        }
        
        // ========================================
        // INITIALISATION
        // ========================================
        
        // Charger les donn√©es au d√©marrage
        document.addEventListener('DOMContentLoaded', () => {
            loadFromGoogleSheets();
        });
        
        // Rafra√Æchir toutes les 5 minutes
        setInterval(refreshData, 5 * 60 * 1000);
    </script>
</body>
</html>
